version: "3.9"
services:
  web:
    image: git.astralelite.org/ae/encrypted-onion-forum:latest
    container_name: onion-forum
    expose:
      - "8080"
    environment:
      - FORUM_DB_PATH=/data/forum.db
      - PORT=8080
    volumes:
      - ./forum_data:/data
    restart: unless-stopped

  tor:
    image: git.astralelite.org/ae/encrypted-onion-forum:tor
    container_name: onion-forum-tor
    depends_on:
      - web
    volumes:
      - ./tor_data:/var/lib/tor
    environment:
      - TOR_HIDE=1

    # --- THE FINAL FIX ---
    # 1. Start as Root (Administrator)
    user: root
    # 2. Fix the folder permissions
    # 3. Run Tor directly as Root. 
    #    (Tor will read its config and switch ITSELF to 'debian-tor' safely)
    entrypoint: 
      - /bin/sh
      - -c
      - |
        chown -R 100:100 /var/lib/tor
        echo "Permissions fixed. Starting Tor..."
        exec tor -f /etc/tor/torrc
    # ---------------------

    restart: unless-stopped
